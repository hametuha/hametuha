!function(a){"use strict";Hametuha.models.userTag=Backbone.Model.extend({defaults:{me:!1,name:"",taxonomy_id:0,url:"",number:0}}),Hametuha.collections.tagCollection=Backbone.Collection.extend({models:Hametuha.models.userTag}),Hametuha.views.Tag=Backbone.View.extend({tagName:"a",events:{"click i":"clickHandler"},initialize:function(){_.bindAll(this,"render","clickHandler"),this.model.bind("change",this.render)},render:function(){return this.$el.html(this.model.get("name")+"("+(this.model.get("number")>100?"100+":this.model.get("number"))+")<i></i>"),this.$el.attr("href",this.model.get("url")).attr("data-taxonomy-id",this.model.get("taxonomy_id")).attr("data-term",this.model.get("name")).attr("data-number",this.model.get("number")),this.model.get("me")?this.$el.addClass("me"):this.$el.removeClass("me"),this},clickHandler:function(b){b.preventDefault(),b.stopPropagation();var c=this;return a.ajax(this.model.get("me")?HametuhaUserTag.tagRemove:HametuhaUserTag.tagAdd,{type:"POST",dataType:"json",data:{taxonomy_id:this.model.get("taxonomy_id")},success:function(a){a.success?a.tag?c.model.set(a.tag):(c.$el.remove(),c.model.destroy()):Hametuha.alert(a.message,!0)},error:function(){Hametuha.alert("タグを更新できませんした。",!0)}}),!1}}),Hametuha.views.TagManager=Backbone.View.extend({el:"#post-tags",collection:null,tagList:null,post_id:0,events:{"submit #user-tag-editor":"submitTag"},initialize:function(){_.bindAll(this,"grepItem","appendItem","watchCollectionCount","submitTag"),this.tagList=a("#user-tag-list"),this.post_id=this.tagList.attr("data-post-id"),this.collection=new Hametuha.collections.tagCollection,this.tagList.find("a").each(this.grepItem),this.collection.bind("add",this.appendItem),this.collection.bind("remove",this.watchCollectionCount)},grepItem:function(b,c){var d=new Hametuha.models.userTag;d.set({me:a(c).hasClass("me"),name:a(c).attr("data-term"),taxonomy_id:a(c).attr("data-taxonomy-id"),url:a(c).attr("href"),number:a(c).attr("data-number")}),this.collection.add(d),this.appendItem(d)},appendItem:function(a){var b=new Hametuha.views.Tag({model:a}),c=this.$el.find("a[data-taxonomy-id="+a.get("taxonomy_id")+"]");c.length?b.setElement(c.get(0)):(this.tagList.append(b.render().$el),this.watchCollectionCount())},watchCollectionCount:function(){this.collection.length?this.tagList.removeClass("no-tag"):this.tagList.addClass("no-tag")},submitTag:function(b){var c=a(b.target).find("input[type=text]"),d=c.val(),e=this;return d.length&&a.ajax(HametuhaUserTag.tagCreate,{type:"POST",dataType:"json",data:{term:d},success:function(d){if(d.success){var f=!1;if(e.collection.each(function(a){a.get("taxonomy_id")===d.tag.taxonomy_id&&(f=!0,a.set(d.tag))}),!f){var g=new Hametuha.models.userTag;g.set(d.tag),e.collection.add(g)}}else Hametuha.alert(d.message,!0);c.val(""),a(b.target).find("input[type=submit]").prop("disabled",!1)},error:function(){a(b.target).find("input[type=submit]").prop("disabled",!1),Hametuha.alert("タグを追加できませんした。",!0)}}),!1}}),a(document).ready(function(){a("input[type=text]","#user-tag-editor").autocomplete({source:HametuhaUserTag.tagSearch,minLength:1,delay:500,select:function(b,c){c.item&&c.item.label&&a("#user-tag-editor").submit()}}),new Hametuha.views.TagManager})}(jQuery);
//# sourceMappingURL=user-tag.min.js.map