{"version":3,"sources":["editor/common.js"],"names":["$","timer","resize","delay","clearTimeout","setTimeout","winHeight","window","height","$container","$editor","pad","outerHeight","document","ready","initTimer","setInterval","length","clearInterval","click","e","preventDefault","url","this","attr","Hametuha","confirm","location","href","on","jQuery","angular","module","filter","string","context","toLowerCase","directive","restrict","replace","scope","status","templateUrl","template","$uibModal","postDate","postStatus","postCallback","link","$scope","$elem","ask","open","animation","controller","size","result","then","$uibModalInstance","type","errorMsg","ok","cancel","dismiss","$http","$timeout","api","method","endpoint","data","request","wpApiSettings","root","headers","X-WP-Nonce","nonce","params","start","addClass","end","removeClass","errorHandler","response","alert","message","postData","title","post","tinyMCE","activeEditor","save","content","val","cat","taxonomy","term_id","HameditorPost","categories","forEach","option","active","id","now","Date","toISOString","modified","publish","date","private","delete","redirect"],"mappings":"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","file":"../../editor/common.js","sourcesContent":["/**\n * Description\n */\n\n/*global wpApiSettings: false*/\n/*global Hametuha: false*/\n/*global HameditorPost: true*/\n/*global tinyMCE: false*/\n\n\n(function ($) {\n  'use strict';\n\n  var timer;\n\n  /**\n   * Resize Tiny MCE\n   *\n   * @param {Number} [delay]\n   */\n  function resize(delay) {\n    if (!delay) {\n      delay = 200;\n    }\n    if (timer) {\n      clearTimeout(timer);\n    }\n    timer = setTimeout(function () {\n      var winHeight  = $(window).height(),\n          $container = $('.container--hameditor'),\n          $editor    = $('.mce-edit-area iframe'),\n          height     = $editor.height(),\n          pad        = winHeight - $container.outerHeight();\n      $editor.height(height + pad - 1);\n    }, delay);\n  }\n\n\n  // Initialize\n  $(document).ready(function () {\n\n    var initTimer = setInterval(function () {\n      if ($('.mce-edit-area iframe').length) {\n        clearInterval(initTimer);\n        resize(20);\n      }\n    }, 100);\n\n    $('#quit-editting').click(function (e) {\n      e.preventDefault();\n      var url = $(this).attr('href');\n      Hametuha.confirm('編集をやめてこのページを移動しますか？ 保存していない変更は失われます。', function () {\n        window.location.href = url;\n      });\n    });\n  });\n\n  // Resize on window size change\n  $(window).on('resize', function () {\n    resize();\n  });\n\n\n})(jQuery);\n\n\nangular.module('hametuha')\n  .filter('i18n', [function () {\n    'use strict';\n    return function (string, context) {\n      switch (context) {\n        case 'postStatus':\n          switch (string.toLowerCase()) {\n            case 'publish':\n              return '公開済み';\n            case 'future':\n              return '公開予約';\n            case 'private':\n              return '非公開';\n            case 'auto-draft':\n            case 'draft':\n              return '下書き';\n            case 'pending':\n              return 'レビュー待ち';\n            default:\n              return string;\n          }\n          break;\n        case 'postStatusLabel':\n          switch (string.toLowerCase()) {\n            case 'publish':\n            case 'future':\n              return 'success';\n            case 'private':\n              return 'danger';\n            case 'pending':\n              return 'warning';\n            default:\n              return 'default';\n          }\n          break;\n        default:\n          return string;\n      }\n    };\n  }])\n  .directive('postStatus', function () {\n    'use strict';\n    return {\n      restrict   : 'E',\n      replace    : true,\n      scope      : {\n        status: '@'\n      },\n      templateUrl: Hametuha.template('post-status.html')\n    };\n  })\n  .directive('postPublisher', ['$uibModal', function ($uibModal) {\n    'use strict';\n    return {\n      restrict   : 'E',\n      replace    : false,\n      scope      : {\n        postDate    : '=',\n        postStatus  : '@',\n        postCallback: '@'\n      },\n      templateUrl: Hametuha.template('post-publisher.html'),\n      link       : function ($scope, $elem, attr) {\n\n        $scope.ask = function () {\n          var modal = $uibModal.open({\n            animation  : true,\n            templateUrl: Hametuha.template('post-date-selector.html'),\n            controller : 'postDateSelector',\n            size       : 'sm'\n          });\n          modal.result.then(\n            function (result) {\n            },\n            function () {\n              // Do nothing.\n            }\n          );\n        };\n      }\n    };\n  }])\n  .controller('postDateSelector', ['$scope', '$uibModalInstance', function ($scope, $uibModalInstance) {\n    'use strict';\n\n    $scope.type = '';\n\n    $scope.errorMsg = '';\n\n    $scope.ok = function () {\n      $scope.errorMsg = 'だめじゃん';\n      // $uibModalInstance.close('来年の4月');\n    };\n\n    $scope.cancel = function () {\n      $scope.errorMsg = '';\n      $uibModalInstance.dismiss('cancel');\n    };\n  }])\n  .controller('hametuhaEditor', ['$scope', '$http', '$timeout', function ($scope, $http, $timeout) {\n    'use strict';\n\n    /**\n     * Request endpoint\n     *\n     * @param {String} method\n     * @param {String} endpoint\n     * @param {Object} [data]\n     * @returns {*}\n     */\n    function api(method, endpoint, data) {\n      var request = {\n        method : method,\n        url    : wpApiSettings.root + endpoint,\n        headers: {\n          'X-WP-Nonce': wpApiSettings.nonce\n        }\n      };\n      if (data) {\n        switch (method) {\n          case 'POST':\n          case 'PUT':\n            request.data = data;\n            break;\n          default:\n            request.params = data;\n            break;\n        }\n      }\n      return $http(request);\n    }\n\n    /**\n     * Show indicator\n     */\n    function start() {\n      $('.hameditor__actions').addClass('hameditor__actions--loading');\n    }\n\n    /**\n     * Hide indicator\n     */\n    function end() {\n      $('.hameditor__actions').removeClass('hameditor__actions--loading');\n    }\n\n    /**\n     * Show error message\n     *\n     * @param {Object} response\n     */\n    function errorHandler(response) {\n      Hametuha.alert(response.data.message, true);\n    }\n\n    /**\n     * Get initial data\n     *\n     * @param {Object} data\n     * @returns {Object}\n     */\n    function postData(data) {\n      data.title = $scope.post.title;\n      tinyMCE.activeEditor.save();\n      data.content = $('#hamce').val();\n      data.cat = {\n        taxonomy: 'anpi_cat',\n        term_id : $scope.post.cat\n      };\n      return data;\n    }\n\n    $scope.post = HameditorPost;\n\n    HameditorPost.categories.forEach(function (option) {\n      if (option.active) {\n        $scope.post.cat = option.id;\n      }\n    });\n\n    /**\n     * Save post\n     */\n    $scope.save = function () {\n      start();\n      var now = (new Date()).toISOString();\n      api('POST', 'wp/v2/' + $scope.post.type + '/' + $scope.post.id, postData({\n        modified: now\n      })).then(\n        function (response) {\n          $scope.post.modified = now;\n          $scope.post.url = response.data.link;\n          Hametuha.alert('保存しました。', 'success', 2000);\n        },\n        errorHandler\n      ).then(end);\n    };\n\n    /**\n     * Publish post\n     */\n    $scope.publish = function () {\n      Hametuha.confirm('公開してよろしいですか？', function () {\n        start();\n        var now = (new Date()).toISOString();\n        api('POST', 'wp/v2/' + $scope.post.type + '/' + $scope.post.id, postData({\n          status: 'publish',\n          date  : now\n        })).then(\n          function (response) {\n            $scope.post.status = 'publish';\n            $scope.post.modified = now;\n            $scope.post.date = now;\n            $scope.post.url = response.data.link;\n            Hametuha.alert('安否情報を公開しました！', 'success', 2000);\n          },\n          errorHandler\n        ).then(end);\n      });\n    };\n\n    /**\n     * Make it private\n     */\n    $scope.private = function () {\n      start();\n      api('POST', 'wp/v2/' + $scope.post.type + '/' + $scope.post.id, postData({\n        status: 'private'\n      })).then(\n        function (response) {\n          $scope.post.status = 'private';\n          $scope.post.url = response.data.link;\n          Hametuha.alert('投稿を非公開にしました。', 'warning', 2000);\n        },\n        errorHandler\n      ).then(end);\n    };\n\n    /**\n     * Delete post\n     *\n     * @param {String} redirect\n     */\n    $scope.delete = function (redirect) {\n      Hametuha.confirm('この投稿を削除してよろしいですか？ この操作は取り消せません。', function () {\n        start();\n        api('DELETE', 'wp/v2/' + $scope.post.type + '/' + $scope.post.id).then(\n          function () {\n            Hametuha.alert('削除しました。一覧に移動します。', 'warning', 2000);\n            $timeout(function () {\n              window.location.href = redirect;\n            }, 2000);\n          },\n          errorHandler\n        ).then(end);\n      }, true);\n    };\n\n  }]);\n"]}