{"version":3,"sources":["editor/common.js"],"names":["$","resize","delay","timer","clearTimeout","setTimeout","winHeight","window","height","$container","$editor","pad","outerHeight","document","ready","initTimer","setInterval","length","clearInterval","click","e","preventDefault","url","this","attr","Hametuha","confirm","location","href","on","jQuery","angular","module","filter","string","context","toLowerCase","directive","restrict","replace","scope","status","templateUrl","template","$uibModal","postDate","postStatus","postCallback","link","$scope","$elem","ask","modal","open","animation","controller","size","result","then","$uibModalInstance","type","errorMsg","ok","cancel","dismiss","$http","$timeout","api","method","endpoint","data","request","wpApiSettings","root","headers","X-WP-Nonce","nonce","params","start","addClass","end","removeClass","errorHandler","response","alert","message","postData","title","post","tinyMCE","activeEditor","save","content","val","cat","taxonomy","term_id","HameditorPost","categories","forEach","option","active","id","now","Date","toISOString","modified","publish","date","redirect"],"mappings":"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","file":"../../editor/common.js","sourcesContent":["/**\n * Description\n */\n\n/*global wpApiSettings: false*/\n/*global Hametuha: false*/\n/*global HameditorPost: true*/\n/*global tinyMCE: false*/\n\n\n(function ($) {\n  'use strict';\n\n  var timer;\n\n  /**\n   * Resize Tiny MCE\n   *\n   * @param {Number} [delay]\n   */\n  function resize(delay) {\n    if (!delay) {\n      delay = 200;\n    }\n    if (timer) {\n      clearTimeout(timer);\n    }\n    timer = setTimeout(function () {\n      var winHeight  = $(window).height(),\n          $container = $('.container--hameditor'),\n          $editor    = $('.mce-edit-area iframe'),\n          height     = $editor.height(),\n          pad        = winHeight - $container.outerHeight();\n      $editor.height(height + pad - 1);\n    }, delay);\n  }\n\n\n  // Initialize\n  $(document).ready(function () {\n\n    var initTimer = setInterval(function () {\n      if ($('.mce-edit-area iframe').length) {\n        clearInterval(initTimer);\n        resize(20);\n      }\n    }, 100);\n\n    $('#quit-editting').click(function (e) {\n      e.preventDefault();\n      var url = $(this).attr('href');\n      Hametuha.confirm('編集をやめてこのページを移動しますか？ 保存していない変更は失われます。', function () {\n        window.location.href = url;\n      });\n    });\n  });\n\n  // Resize on window size change\n  $(window).on('resize', function () {\n    resize();\n  });\n\n\n})(jQuery);\n\n\nangular.module('hametuha')\n  .filter('i18n', [function () {\n    'use strict';\n    return function (string, context) {\n      switch (context) {\n        case 'postStatus':\n          switch (string.toLowerCase()) {\n            case 'publish':\n              return '公開済み';\n            case 'future':\n              return '公開予約';\n            case 'private':\n              return '非公開';\n            case 'auto-draft':\n            case 'draft':\n              return '下書き';\n            case 'pending':\n              return 'レビュー待ち';\n            default:\n              return string;\n          }\n          break;\n        case 'postStatusLabel':\n          switch (string.toLowerCase()) {\n            case 'publish':\n            case 'future':\n              return 'success';\n            case 'private':\n              return 'danger';\n            case 'pending':\n              return 'warning';\n            default:\n              return 'default';\n          }\n          break;\n        default:\n          return string;\n      }\n    };\n  }])\n  .directive('postStatus', function () {\n    'use strict';\n    return {\n      restrict   : 'E',\n      replace    : true,\n      scope      : {\n        status: '@'\n      },\n      templateUrl: Hametuha.template('post-status.html')\n    };\n  })\n  .directive('postPublisher', ['$uibModal', function ($uibModal) {\n    'use strict';\n    return {\n      restrict   : 'E',\n      replace    : false,\n      scope      : {\n        postDate    : '=',\n        postStatus  : '@',\n        postCallback: '@'\n      },\n      templateUrl: Hametuha.template('post-publisher.html'),\n      link       : function ($scope, $elem, attr) {\n\n        $scope.ask = function () {\n          var modal = $uibModal.open({\n            animation  : true,\n            templateUrl: Hametuha.template('post-date-selector.html'),\n            controller : 'postDateSelector',\n            size       : 'sm'\n          });\n          modal.result.then(\n            function (result) {\n            },\n            function () {\n              // Do nothing.\n            }\n          );\n        };\n      }\n    };\n  }])\n  .controller('postDateSelector', ['$scope', '$uibModalInstance', function ($scope, $uibModalInstance) {\n    'use strict';\n\n    $scope.type = '';\n\n    $scope.errorMsg = '';\n\n    $scope.ok = function () {\n      $scope.errorMsg = 'だめじゃん';\n      // $uibModalInstance.close('来年の4月');\n    };\n\n    $scope.cancel = function () {\n      $scope.errorMsg = '';\n      $uibModalInstance.dismiss('cancel');\n    };\n  }])\n  .controller('hametuhaEditor', ['$scope', '$http', '$timeout', function ($scope, $http, $timeout) {\n    'use strict';\n\n    /**\n     * Request endpoint\n     *\n     * @param {String} method\n     * @param {String} endpoint\n     * @param {Object} [data]\n     * @returns {*}\n     */\n    function api(method, endpoint, data) {\n      var request = {\n        method : method,\n        url    : wpApiSettings.root + endpoint,\n        headers: {\n          'X-WP-Nonce': wpApiSettings.nonce\n        }\n      };\n      if (data) {\n        switch (method) {\n          case 'POST':\n          case 'PUT':\n            request.data = data;\n            break;\n          default:\n            request.params = data;\n            break;\n        }\n      }\n      return $http(request);\n    }\n\n    /**\n     * Show indicator\n     */\n    function start() {\n      $('.hameditor__actions').addClass('hameditor__actions--loading');\n    }\n\n    /**\n     * Hide indicator\n     */\n    function end() {\n      $('.hameditor__actions').removeClass('hameditor__actions--loading');\n    }\n\n    /**\n     * Show error message\n     *\n     * @param {Object} response\n     */\n    function errorHandler(response) {\n      Hametuha.alert(response.data.message, true);\n    }\n\n    /**\n     * Get initial data\n     *\n     * @param {Object} data\n     * @returns {Object}\n     */\n    function postData(data) {\n      data.title = $scope.post.title;\n      tinyMCE.activeEditor.save();\n      data.content = $('#hamce').val();\n      data.cat = {\n        taxonomy: 'anpi_cat',\n        term_id : $scope.post.cat\n      };\n      return data;\n    }\n\n    $scope.post = HameditorPost;\n\n    HameditorPost.categories.forEach(function (option) {\n      if (option.active) {\n        $scope.post.cat = option.id;\n      }\n    });\n\n    /**\n     * Save post\n     */\n    $scope.save = function () {\n      start();\n      var now = (new Date()).toISOString();\n      api('POST', 'wp/v2/' + $scope.post.type + '/' + $scope.post.id, postData({\n        modified: now\n      })).then(\n        function (response) {\n          $scope.post.modified = now;\n          $scope.post.url = response.data.link;\n          Hametuha.alert('保存しました。', 'success', 2000);\n        },\n        errorHandler\n      ).then(end);\n    };\n\n    /**\n     * Publish post\n     */\n    $scope.publish = function () {\n      Hametuha.confirm('公開してよろしいですか？', function () {\n        start();\n        var now = (new Date()).toISOString();\n        api('POST', 'wp/v2/' + $scope.post.type + '/' + $scope.post.id, postData({\n          status: 'publish',\n          date  : now\n        })).then(\n          function (response) {\n            $scope.post.status = 'publish';\n            $scope.post.modified = now;\n            $scope.post.date = now;\n            $scope.post.url = response.data.link;\n            Hametuha.alert('安否情報を公開しました！', 'success', 2000);\n          },\n          errorHandler\n        ).then(end);\n      });\n    };\n\n    /**\n     * Make it private\n     */\n    $scope.private = function () {\n      start();\n      api('POST', 'wp/v2/' + $scope.post.type + '/' + $scope.post.id, postData({\n        status: 'private'\n      })).then(\n        function (response) {\n          $scope.post.status = 'private';\n          $scope.post.url = response.data.link;\n          Hametuha.alert('投稿を非公開にしました。', 'warning', 2000);\n        },\n        errorHandler\n      ).then(end);\n    };\n\n    /**\n     * Delete post\n     *\n     * @param {String} redirect\n     */\n    $scope.delete = function (redirect) {\n      Hametuha.confirm('この投稿を削除してよろしいですか？ この操作は取り消せません。', function () {\n        start();\n        api('DELETE', 'wp/v2/' + $scope.post.type + '/' + $scope.post.id).then(\n          function () {\n            Hametuha.alert('削除しました。一覧に移動します。', 'warning', 2000);\n            $timeout(function () {\n              window.location.href = redirect;\n            }, 2000);\n          },\n          errorHandler\n        ).then(end);\n      }, true);\n    };\n\n  }]);\n"]}